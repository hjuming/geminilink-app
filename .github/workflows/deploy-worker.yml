# .github/workflows/deploy-worker.yml
#
# v4 最終版：
# 1. 現在會推送 "兩個" 執行時機密 (GEMINI_API_KEY 和 REGISTRATION_KEY)。
# 2. 這個 workflow 會在 "push" (推送) 程式碼到 "main" (主) 分支時自動觸發。

name: Deploy GeminiLink Worker

on:
  push:
    branches:
      - main  # 僅在 main 分支上觸發

jobs:
  deploy:
    runs-on: ubuntu-latest # 使用最新的 Ubuntu 虛擬機
    name: Deploy Worker
    steps:
      - name: Checkout (取得程式碼)
        uses: actions/checkout@v4

      - name: Setup Bun (安裝 Bun)
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies (安裝依賴套件)
        run: bun install --frozen-lockfile

      # 
      # 步驟 A：將 GitHub Secrets 注入到 Cloudflare Secrets (執行時機密)
      #
      - name: Set Gemini API Key Secret (設定 Gemini 金鑰)
        run: echo ${{ secrets.GEMINI_API_KEY }} | npx wrangler secret put GEMINI_API_KEY
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set Registration Key Secret (設定註冊安全碼)
        run: echo ${{ secrets.REGISTRATION_KEY }} | npx wrangler secret put REGISTRATION_KEY
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      #
      # 步驟 B：部署 Worker 程式碼 (部署時機密)
      #
      - name: Deploy to Cloudflare (部署 Worker)
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
